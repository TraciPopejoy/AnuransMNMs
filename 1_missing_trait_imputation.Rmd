---
title: "missing_traits"
author: "TP DuBose"
date: "1/19/2022"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse); library(knitr)
library(Rphylopars); library(ggtree); library(treeplyr)
knitr::opts_chunk$set(echo = FALSE)
```

## Trait Imputation Methods

[Penone et al. 2014](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12232) reviewed imputation methods and [Johnson et al. 2021](https://onlinelibrary.wiley.com/doi/full/10.1111/geb.13185) addressed how bias affects the top methods. 

Generally, using phylogentic information reduces error but bias in trait completeness leads to different methods being *best*.

#### Bias in our trait dataset

```{r atraiu2, echo=F, warning=F, message=F, fig.width=4.5,fig.height=4}
trait_db_raw<-read_csv('ATraiU 2.0/ATraiU2_full_2022JULY3.csv') %>%
  filter(lifeStage %in% c('adult','unknown'),
         traitName != 'Tforage_optim') 
foc_taxa<-read.csv('focal_taxa.csv') %>% pull(species)
tax_ord<-trait_db_raw %>% 
  distinct(species, traitName, .keep_all=T) %>%
  group_by(species) %>%
  tally() %>% ungroup() %>%
  arrange(desc(n)) %>% pull(species)
trait_ord<-trait_db_raw %>% 
  filter(species %in% tax_ord) %>%
  distinct(species, traitName) %>%
  count(traitName) %>% 
  arrange(desc(n)) %>% pull(traitName) 
trait_db_raw %>%
  distinct(species, traitName) %>%
  mutate(presence=1,
         TraitF=factor(traitName, levels=trait_ord)) %>% 
  pivot_wider(names_from=species, values_from=presence,
              values_fill=0) %>%
  ungroup() %>% 
  select(-traitName) %>%
  pivot_longer(-TraitF) %>%
  mutate(taxaF=factor(name, 
                      levels=tax_ord)) %>% 
  ggplot()+
  geom_tile(aes(x=TraitF, y=taxaF, fill=as.factor(value))) +
  scale_fill_manual(values=c(NA,'black'), name='Trait Available',
                    labels=c('no', 'yes'))+
  scale_y_discrete(name="Taxa")+
  theme_bw()+
  theme(axis.text.x= element_text(angle=40, hjust=.9),
        legend.position = 'top',
        axis.title = element_blank(), 
        axis.text.y=element_text(face='italic'))
trait_complete<-trait_db_raw %>%
  filter(species %in% tax_ord,
         traitName %in% c('Tpref','Tmerge','CTmax','CTmin')) %>%
  distinct(species, traitName) %>% 
  group_by(species) %>% count() %>%
  mutate(comp=n/4)
nrow(trait_complete)
```

This would give us `r nrow(trait_complete)` species total: `r trait_complete %>% filter(comp >= 0.5) %>% nrow()` species with >= 50% trait completeness and `r trait_complete %>% filter(comp < 0.5) %>% nrow()` species below that mark.

# Revisiting how different imputation methods work under bias
```{r, echo=FALSE, fig.cap="", out.width = '90%', out.height='80%', fig.align='center'}
knitr::include_graphics("C:/Users/Owner/Desktop/Git/AnuranMNMs/input_data/Johnson2021_error_trait_imputatoin.png")
```

# Anuran Phylogeny

Using the phylogeny from Jetz & Pyron 2019, we can impute traits for the `r length(tax_ord)` species we have trait information for.

```{r phylogeny, echo = F, fig.height=4.5}
taxa_table<-data.frame(species=foc_taxa) %>%
  mutate(Tree.name.syn=case_when(species == 'Dryophytes squirellus'~ 'Hyla squirella',
                             species == 'Dryophytes gratiosus'~ 'Hyla gratiosa',
                             species == 'Dryophytes cinereus'~'Hyla cinerea',
                             grepl('Dryophytes',species)~gsub('Dryophytes','Hyla', species),
                             species == 'Lithobates areolatus'~ 'Rana areolata',
                             species == 'Lithobates catesbeianus'~'Rana catesbeiana',
                             species == 'Lithobates sevosus'~'Rana sevosa',
                             species == 'Lithobates sylvaticus'~ 'Rana sylvatica',
                             species == 'Lithobates sphenocephalus'~'Rana sphenocephala',
                             grepl('Lithobates',species)~gsub('Lithobates','Rana', species),
                             T~species),
         Tree.name=sub(' ','_',Tree.name.syn)) %>%
  filter(species != 'Lithobates kauffeldi')

# import phylogeny from Jetz and Pyron 2018
tree_orig <- read.tree(file = "input_data/amph_shl_new_Consensus_7238.tre") 
tree.pruned <- keep.tip(phy = tree_orig, 
                        tip = taxa_table$Tree.name) 
taxa_table$node<-nodeid(tree.pruned, taxa_table$Tree.name)
plot(tree.pruned, font=2)
```

```{r}
df<-trait_complete %>% right_join(taxa_table, by='species') %>%
            mutate(tree.lab=paste0(substr(Tree.name,1,1), '. ',
                                   sub('.*\\_','',Tree.name))) %>%
  replace_na(list(n=0, comp=0))
trait_tree<-left_join(tree.pruned, df)
library(MetBrewer)

ggtree(trait_tree, aes(color=comp, label=tree.lab), size=3)+ 
  geom_tiplab(as_ylab=T)+
  scale_color_gradientn('Trait\nCompleteness',
                        colors = met.brewer("VanGogh1"),
                        labels=scales::percent)
```

# Investigate Life History Trait variation in focal taxa

```{r}
atraiu<-read_csv('C:/Users/Owner/Downloads/ATraiU/ATraiU_summary_values_2020AUG.csv')
names(atraiu)
library(vegan)
atraiu_num1<-atraiu %>% 
  select(latin_name, max.longevity_max_yrs,
         max.max_length_mm_fem, max.fecundity_max,
         min.maturity_min_yrs_fem, 
         min.hatch_time_min, 
         min.metamorph_time_min, min.metamorph_size_min) %>%
  mutate(across(-latin_name, as.numeric),
         min.metamorph_time_min=min.metamorph_time_min+1) %>%
  mutate(across(-latin_name, log10)) %>% # View()
  mutate(genus=gsub("(\\w+).*", "\\1", latin_name)) %>%
  group_by(genus) %>%
  mutate_at(vars(-latin_name, -group_cols()), list(~ifelse(is.na(.), mean(., na.rm = TRUE),.))) %>% 
  ungroup()%>%
  drop_na()
atraiu_num <- atraiu_num1 %>% 
  select(-latin_name, -genus)  %>%
  as.matrix()
rownames(atraiu_num)<-atraiu_num1$latin_name

atraiu_gower<-vegdist(atraiu_num, method='gower', na.rm=T)
atrai_pcoa<-prcomp(atraiu_num)
summary(atrai_pcoa)
```

```{r trait biplot, echo=F}
library(ggfortify); library(ggrepel)
# stats help: https://stats.stackexchange.com/questions/276645/arrows-of-underlying-variables-in-pca-biplot-in-r
loaded = atrai_pcoa$rotation %*% diag(atrai_pcoa$sdev)
pc_var<-loaded %>% as_tibble() %>% 
  bind_cols(variable=rownames(loaded)) %>%
  mutate(across(-variable, function(x){x * 0.3 * sqrt(nrow(atraiu_num) - 1)}),
         ar_lab=sub('_min','', sub('_max','',sub('_mm', '', sub('_yrs', '', sub('.*\\.','',variable)))))) %>%
  rename('PC1'=V1, 'PC2'=V2) %>% select(variable, ar_lab, PC1, PC2)
#pc_var
fortify(atrai_pcoa) %>%
  rownames_to_column('species') %>%
  left_join(trait_complete) %>%
  mutate(pt_shp=ifelse(is.na(comp),NA,'potential')) %>%
  ggplot()+
  geom_point(aes(x=PC1, y=PC2, color=comp, shape=pt_shp), size=3)+
  geom_segment(data=pc_var, x=0, y=0, aes(xend=PC1, yend=PC2),
               arrow=arrow(length = unit(0.01, "npc")))+
  geom_text_repel(data=pc_var, aes(x=PC1, y=PC2, label=ar_lab), size=3)+
  geom_text_repel(data=. %>% filter(comp<.4),
                  aes(x=PC1, y=PC2, label=species), size=3)+
  scale_shape_manual(na.value=20, values=16)+
  scale_color_gradientn('Trait\nCompleteness',
                        colors = met.brewer("VanGogh1"),
                        labels=scales::percent,
                       na.value='grey90')+
  theme_classic()+
  theme(legend.position=c(.15,.9))
rm(atraiu_gower,atraiu_num, atraiu_num1, tree_orig, pc_var, atrai_pcoa)
```

```{r}
kable(trait_complete %>% filter(comp > .5) %>%
  arrange(desc(n)), digits=2)
```

# Use Rphylopars to imput continuous trait data
```{r pressure, warning=F, message=F, echo=F, , out.height='50%'}
trait_matrix<-read.csv('ATraiU 2.0/ATraiU2_summary_values_2022JULY.csv') %>%
  left_join(taxa_table, by='species') %>% 
  select(Tree.name, trait_ord[2:6]) %>%
  rename(species=Tree.name) %>%
  filter(!is.na(species)) # removes Lithobates kauffeldi

```
We use the following code to impute the traits using the *Rphylopars* package. 
- estimates phylogenetic and phenotypic variance-covariance matrices 
- assumes phenotypic covariance is equivalent among species
- uses a Browning motion model of evolution
Essentially is a maximum likelihood frequentist way to impute traits

```{r results, echo=T, out.width='60%'}
p_BM <- phylopars(trait_data = data.frame(trait_matrix), tree = tree.pruned,
                  phylo_correlated=F, model='BM')
summary(p_BM)
```


```{r results graph,  fig.height=4, echo=F}
#results!
imp_results <- p_BM$anc_recon[1:length(tree.pruned$tip.label),] %>%
  as_tibble() %>%
  bind_cols(species=rownames(p_BM$anc_recon[1:length(tree.pruned$tip.label),])) %>%
  left_join(trait_matrix, by='species')%>%
  pivot_longer(-species) %>%
  mutate(variable=gsub('.y','', gsub('\\.x','', name)),
         impute=ifelse(grepl('y',name), 'No','Yes'))  %>%
  dplyr::select(-name) %>%
  pivot_wider(names_from = impute, values_from=value)  %>%
  mutate(Imputed=ifelse(is.na(No), 'Imputed', 'Literature'),
         genus=gsub("\\_.*", "\\1", species),
         family=case_when(genus %in% c('Acris','Hyla','Pseudacris') ~ 'Hylidae',
                          genus %in% c('Anaxyrus','Incilius') ~ 'Bufonidae',
                          genus %in% c('Lithobates','Rana') ~'Ranidae',
                          genus == 'Gastrophryne'~'Microhylidae',
                          genus == 'Scaphiopus' ~ 'Scaphiopodidae')) 
imp_results %>%
  ggplot(aes(x=family, y=Yes, color=Imputed))+
  geom_boxplot(color='black', fill=NA, outlier.alpha = 0)+
  geom_point(position=position_dodge(width=0.5))+
  facet_wrap(~variable, scales='free_y')+
  labs(x='Family',y='Value')+
  scale_color_manual(values=c('forestgreen','goldenrod'))+
  theme_classic() +
  theme(legend.position='top',
        axis.text.x = element_text(angle=20, hjust=.87, vjust=1))
```

# So species to consider are:

```{r table of taxa, warning=F, message=F, echo=F}
n_imputed<-imp_results %>%
  group_by(family, genus, species) %>%
  summarize(n_imp=sum(Imputed=='Imputed'), .groups='drop')
kable(n_imputed %>%
  filter(n_imp < 3) %>%
  group_by(family, genus) %>% 
    summarize(N=n(), Species=paste(gsub('_',' ', species), collapse = ', '),
              .groups='drop'))
```

```{r species discussion, fig.width=8, fig.height=2.5}
n_imputed %>%
  ggplot()+
  geom_bar(aes(x=n_imp), fill='goldenrod3', alpha=0.9)+
  geom_text(data=. %>% group_by(n_imp) %>% 
              summarize(labb=paste(species, collapse='\n')),
            aes(x=n_imp, y=2, label=labb), size=3.5)+
  theme_classic()+
  labs(y='N species', x='Traits Imputed')
```

```{r}
rcs<-read_csv('C:/Users/Owner/Desktop/Git/National-RCS/Anuran_RCS_and_components.csv',
              show_col_types=FALSE) %>% 
  filter(grepl('North', extent)) %>%
  select(species, genus, family, AOO_WS_sqkm, RCS_WS) %>%
  # manually adding in 'Lithobates sevosus' information
  bind_rows(data.frame(species='Lithobates sevosus', 
                       genus='Lithobates',family='Ranidae',
                       AOO_WS_sqkm=737.8, RCS_WS=1.0001)) %>%
  mutate(rankRCS=91-rank(RCS_WS))
n_imputed %>% rename(Tree.name=species) %>%
  left_join(taxa_table, by=c('Tree.name')) %>% left_join(rcs, by='species') %>%
  ggplot(aes(x=RCS_WS, y=n_imp))+
  geom_point()+
  geom_text_repel(data=. %>% filter(n_imp<3), aes(label=species), 
                  min.segment.length = .01, size=2.5)+
  geom_hline(yintercept=2.7)+
  labs(y='Number of Imputed Traits',
       x='RCS index - North American extent, watershed grain size')+
  theme_classic()
```

# Outputting the trait tables to query for MNM models

```{r}
imp_results %>%
  select(species, variable, Yes, Imputed) %>%
  group_by(species) %>%
  mutate(imp.trait=paste(ifelse(Imputed=='Imputed', variable, ''), collapse=''),
         n.imp=sum(Imputed=='Imputed')) %>%
  select(-Imputed) %>%
  pivot_wider(names_from=variable, values_from=Yes) %>%
  filter(n.imp < 3) %>%
  rename(Tree.name=species) %>% left_join(taxa_table, by='Tree.name') %>%
  ungroup() %>%
  select(species, imp.trait, n.imp, Mass, Tmerge, Tpref, CTmax, CTmin) %>%
  left_join(atraiu %>% select(latin_name, s.fossorial, s.arboreal),
            by=c('species'='latin_name')) %>%
  write.csv('input_data/inputed_physio_traits.csv', row.names=F)
```