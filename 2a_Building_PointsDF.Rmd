---
title: "Download Occurrence Points"
author: "TP DuBose"
date: "11/9/2022"
output: html_document
---

```{r setup, include=FALSE}
library(rgbif); library(tidyverse)
library(sf); library(maps); library(stars)
library(MetBrewer)
```

# Building points at which to run the MNMs

Now that I have the species pool, I identify points to run the models at for two different scales: intraspecific (across the SE US) and interspecific (two different ways based on 1 point where the trait was analyzed and intraspecific variation). The code chunk below creates a grid across the southeastern US that we will use to get the points we will use as inputs into the microclimate model. 

```{r}
anura.tax<-read.csv('input_data/inputed_physio_traits.csv')
focal_spp<-anura.tax %>% pull(species) %>% unique()

se<-st_as_sf(map('state',c('mississippi', 'georgia', 'florida', 'south carolina', 
                           'north carolina', 'virginia', 'alabama', 'tennessee'), 
                 fill=T, plot=F)) %>%
  st_make_valid() %>%
  st_transform(st_crs("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=37.5 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=km +no_defs"))
# create raster of study extent
#se_r<-st_rasterize(se, dx=1, dy=1) %>% #turn into a raster of 1x1 kilometers
 # st_as_sf(as_points = FALSE, merge = FALSE) %>%  #turn into a polygon
  #                     rowid_to_column() # add an id column
```

Now that we've have that grid, we then populate the grid with known occurrences for our focal species. Within each grid, we then identify the point with the lowest distance to all other points (and maximum year if that point is represented multiple times). We will create a 2020 microclimate for that point, which will be used as input for all species occupying that grid cell. This loses some of the biology associated with the point occurrence (location & year information) but does make sure that the comparisons are based on the ecotherm model, not subtle differences in the microclimate model. 

```{r}
# first we pull in each species' occurrence points from GBIF & HerpMapper
anuran_pts<-NULL
for(s in focal_spp){
  anuran_pts<-bind_rows(anuran_pts,
                        read.csv(paste0('../National-RCS/data/occ_data/',s,'_20210330.csv')) %>% 
                        # only keep this information about the occurrence point
                          dplyr::select(source, species, Longitude, Latitude,
                                        coordinateUncertaintyInMeters, coordinatePrecision, elevation, 
                                        day, month, year))
}
```


```{r}
aoos<-anuran_pts %>%  
  st_as_sf(coords=c('Longitude','Latitude'), crs=st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")) %>%
  st_join(se %>% st_make_valid() %>% st_transform("+proj=longlat +ellps=WGS84 +datum=WGS84")) %>%
  filter(!is.na(ID)) %>%
  group_by(species) %>%
  summarize(n=n(),
            medyear=median(year, na.rm=T),
            year25=quantile(year, .25, na.rm=T),
            year75=quantile(year,.75, na.rm=T)) %>%
  st_buffer(5) 
aoos %>%
  bind_cols(area=st_area(.))
  
```

```{r, fig.height=2.7, fig.width=6.5}
iucn_all<-read_sf('../ANURA') %>% 
  filter(binomial %in% focal_spp,
         !grepl('Extinct',legend)) %>%
  group_by(binomial) %>% summarize() 
latlist_iucn<-NULL
for(i in iucn_all$binomial){
  latlist_iucn<-bind_rows(latlist_iucn,
            iucn_all %>%
    filter(binomial == i) %>%
    st_rasterize(dx=.5, dy=.5) %>%
   # st_as_sf(as_points = TRUE, merge = FALSE) %>%
    st_coordinates() %>%
    as_tibble() %>% mutate(species=i))
} 

na_r<-st_bbox(c('xmin'=-140, 'ymin'=0, 'xmax'=-40, 'ymax'=70))%>%
  st_as_sfc() %>% st_sf(crs=st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")) %>%
  st_rasterize(dx=.5, dy=.5) %>%
  st_as_sf(as_points = FALSE, merge = FALSE) %>%  #turn into a polygon
                       rowid_to_column()
iucnrng<-st_join(na_r, iucn_all) %>% filter(!is.na(binomial)) %>% st_centroid()
latlist_iucn <-st_coordinates(iucnrng) %>% 
  bind_cols(species=iucnrng$binomial)
rm(iucnrng)
se_dl <- se %>% 
  st_transform(st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")) %>%
  st_rasterize(dx=.5, dy=.5) %>% #turn into a raster of 1x1 kilometers
  st_as_sf(as_points = FALSE, merge = FALSE) %>%  #turn into a polygon
                       rowid_to_column()
pt1<-anuran_pts %>%  
  st_as_sf(coords=c('Longitude','Latitude'), 
           crs=st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")) %>%
  st_join(se_dl) %>% filter(!is.na(rowid)) %>%
  distinct(species, rowid, .keep_all = T)
latlist_occs<-st_coordinates(pt1) %>% bind_cols(species=pt1$species)
```

```{r range lat density graph, echo=F, fig.height=3, fig.width=6.5}
max.lat<-st_bbox(se %>% st_transform(st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")))[4]
min.lat<-st_bbox(se %>% st_transform(st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")))[2]
latlist_iucn %>%
            mutate(dist='IUCN range') %>%
            bind_rows(latlist_occs %>% 
                        mutate(dist='occurrences')) %>%
  left_join(anura.tax %>% distinct(family, species), by='species') %>%
   mutate(pltsp=paste0(substr(species, 1,1), '. ', sub(".*? ", "", species))) %>%
  ggplot()+
  geom_density(aes(x=Y, fill=dist, color=dist), alpha=0.8)+
  geom_vline(xintercept=c(min.lat,max.lat))+
  scale_x_continuous('Latitude')+
  scale_y_continuous('Proportion of Range', breaks=c(0,.1,.2,.3,.4))+
  #scale_color_manual('species', values=c(met.brewer('Renoir'), 'grey'),
  #                   aesthetics = c('fill','color')) +
  #facet_grid(dist~family)+
  facet_wrap(~species) +
  scale_fill_grey('Source of Range', labels=c('IUCN range','5km buffered point occurrences'),
                  aesthetics=c('color','fill'))+
  theme_classic()+theme(axis.title=element_text(size=9),
                        axis.text=element_text(size=9),
                        legend.position = 'bottom', 
                        legend.title=element_text(size=8),
                        legend.text = element_text(size=8),
                        legend.margin=margin(t=-10),
                        strip.text=element_text(face='italic'),
                        strip.background = element_blank())
  #guides(fill=guide_legend(nrow=3, size=.5, alpha=1))
ggsave('results/FigS3_propdist_lat.jpg', height=4.5, width=6.5)
rm(iucn_all, iucnrng, latlist_iucn, latlist_occs, na_r)
```
```{r}
latlist %>%
  group_by(species) %>% summarize(percent.dist.below.max.lat=round(ecdf(y)(max.lat)*100,2)) %>%
  arrange(percent.dist.below.max.lat)

```  

```{r}

# We join it with the grid created above
se_pts<-anuran_pts %>% 
  st_as_sf(coords=c('Longitude','Latitude'), crs=st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")) %>%
  st_join(se_r %>% st_transform("+proj=longlat +ellps=WGS84 +datum=WGS84")) %>%
    filter(!is.na(rowid))  # remove points outside of our sample grid

# and then find the point that is closest to all other points 
# as the single point to run for that grid
pts_to_run<-NULL
for(i in unique(se_pts$rowid)){
  pt_rw<-se_pts %>% filter(rowid==i)
  ptd<-pt_rw %>% st_distance() %>% rowSums()
  pts_to_run<-bind_rows(pts_to_run,
                        # find the minimum summed distance among all points
                        bind_cols(pt_rw[which(ptd==min(ptd)),] %>% 
                                    # if multiple points, keep the most recent one
                                    filter(max(year)==year),
                                  t_dist=min(ptd), # report how far away it was from other points
                                  # what other species were in that grid
                                  spp_all=paste(unique(pt_rw$species), collapse=', '),
                                  # what other years represented
                                  year_all=paste(unique(pt_rw$year), collapse=', ')))
}

se_pts_df1 <- pts_to_run %>% distinct(geometry, .keep_all=T) # 1 row per unique point

# NicheMapR needs a dataframe, so output a csv
se_pts_df <- se_pts_df1 %>% st_coordinates() %>% 
  bind_cols(rowid = se_pts_df1$rowid, spp_all=se_pts_df1$spp_all)
write.csv(se_pts_df, 'input_data/points_to_run_df.csv')
```

```{r point grid map, echo=F}
pts_to_run %>% distinct(geometry, .keep_all=T) %>%
  ggplot()+geom_sf(data=se_r %>% st_transform(st_crs(se_pts)), alpha=0.3) + 
  geom_sf(aes(color=species))+theme_classic()
write_sf(pts_to_run, 'input_data/points_ran.shp', quiet=T)
```
